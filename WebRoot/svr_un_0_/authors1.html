<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <style>
    .chart-container {
        height: 330px;
    }

    .chart-tooltip {
        position: absolute;
        display: none;
        padding: 5px;
        max-width: 200px;
        font-size: 12px;
        text-align: center;
        color: #fff;
        background-color: #000;
        border-radius: 4px;
        opacity: 0.8;
    }

    table td {
        text-align: center;
        vertical-align: middle;
    }

    table th {
        text-align: center;
    }

    table.gridtable {
        font-family: verdana, arial, sans-serif;
        font-size: 11px;
        color: #fff;
        border-width: 1px;
        border-color: #666666;
        border-collapse: collapse;
    }

    table.gridtable th {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #353c48;
        background-color: #353c48;
    }

    table.gridtable td {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #353c48;
        background-color: #2a3039;
    }

    .chart {
        width: 100%;
        height: 400px;
    }
    </style>
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/handsontable.css">
    <link rel="stylesheet" href="../css/handsontable.full.css">
    <link rel="stylesheet" href="../css/index.css">
    <!-- 时间选择器 Css -->
    <link rel="stylesheet" type="text/css" href="../css/timepicki1.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body class="skin-blue layout-top-nav" style="height: auto;background: #2a3039;color: #fff;margin: 40px 0 0 95px;">
    <div style="width:90%;margin-left :10px" class="col-md-12">
        <div class="col-md-12 nav-tabs-custom" style="padding-left: 25px;">
            <div id="zjTitle"> 短信用户列表</div>
            <div id="editCell" class="hot handsontable">
            </div>
        </div>
        <!--  
       <table class="table table-striped table-bordered table-hover">
       -->
       <!-- 条件筛选 starts -->
        <div class="col-md-12" style="margin-top: 15px;">
            <div class="col-md-1" style="font-size: 16px;line-height: 80px;">筛选条件:</div>
            <div class="form-group col-md-2" style="margin-left: -50px;">
                <label for="f1">站点</label>
                <select class=" form-control" name="" id="sel_prtu">
                </select>
            </div>
            <div class="form-group col-md-2">
                <label for="f1">设备</label>
                <select class=" form-control" name="" id="sel_prtu1">
                </select>
            </div>
            <div class="form-group col-md-2">
                <label for="f1">模糊查询</label>
                <input type="text" name="" class=" form-control" name="" id="sel_prtu2">
            </div>
            <button id="searchBtn" type="button" class="btn btn-success btn-sm">确定</button>
        </div>
        <!-- 条件筛选 ends -->
        <!-- 短信权限 starts -->
        <div class="col-md-12" >
            <!-- 短信权限设备列表 starts-->
            <div class="col-md-8">
                <div id="authorTitle"> 短信权限设备列表</div>
                <table class="gridtable">
                    <thead>
                        <tr>
                            <th style="width:200px;">姓名</th>
                            <th style="width:800px;">
                                <div>设备报警短信
                                    <a id='savBtn' href='javascript:void(0);' title='保存' style="display:block;text-align:right; float:right;"><span class='fa fa-save'></span>&nbsp;</a>
                                    <a id='notBtn' href='javascript:void(0);' title='反选' style="display:block;text-align:right; float:right;"><span class='fa fa-dot-circle-o'></span>&nbsp;&nbsp;</a>
                                    <a id='allnotBtn' href='javascript:void(0);' title='全不选' style="display:block;text-align:right; float:right;"><span class='fa fa-circle-o'></span>&nbsp;&nbsp;</a>
                                    <a id='allBtn' href='javascript:void(0);' title='全选' style="display:block;text-align:right; float:right;"><span class='fa fa-check-circle'></span>&nbsp;&nbsp;</a>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan=4 id="authorTitle2"></td>
                            <td id="rm1" style="text-align:left;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 短信权限设备列表 ends-->
            <!-- 短信权限状态列表 starts-->
            <div class="col-md-4" style="margin-top: -20px;">
                <div id="authorTitle" style="margin: 20px 0 0 9px;"> 短信权限状态列表</div>
                <table class="gridtable" style="margin: 0px 0 0 9px;">
                    <thead>
                        <tr>
                            <th style="width:200px;">姓名</th>
                            <th style="width:800px;">
                                <div>状态报警短信
                                    <a id='savBtn' href='javascript:void(0);' title='保存' style="display:block;text-align:right; float:right;"><span class='fa fa-save'></span>&nbsp;</a>
                                    <a id='notBtn' href='javascript:void(0);' title='反选' style="display:block;text-align:right; float:right;"><span class='fa fa-dot-circle-o'></span>&nbsp;&nbsp;</a>
                                    <a id='allnotBtn' href='javascript:void(0);' title='全不选' style="display:block;text-align:right; float:right;"><span class='fa fa-circle-o'></span>&nbsp;&nbsp;</a>
                                    <a id='allBtn' href='javascript:void(0);' title='全选' style="display:block;text-align:right; float:right;"><span class='fa fa-check-circle'></span>&nbsp;&nbsp;</a>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan=4 id="authorTitle3"></td>
                            <td id="rm1" style="text-align:left;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 短信权限状态列表 ends-->
        </div>
        <script src="../js/jquery-2.4.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script data-jsfiddle="common" src="../dist/pikaday/pikaday.js"></script>
        <script data-jsfiddle="common" src="../dist/moment/moment.js"></script>
        <script data-jsfiddle="common" src="../dist/zeroclipboard/ZeroClipboard.js"></script>
        <script data-jsfiddle="common" src="../dist/handsontable.js"></script>
        <script src="../js/setup.js"></script>
        <!-- 时间选择器 Js -->
        <!-- <script src="js/timepacker1.js"></script> -->
        <script type="text/javascript">
        /**
         * 验证手机号
         * @param value
         * @param callback
         */
        var phonenoValidator = function(value, callback) {
            //console.log(value+'__'+value.length)
            if (!value || 0 === value.length || value.length != 11) {
                callback(false);
            } else {
                callback(true);
            }
        };
        /**
         * 验证Email
         * @param strEmail
         * @param callback
         *
         */
        var emailValidator = function(strEmail, callback) {
            //console.log(value+'__'+value.length)
            if (strEmail.search(/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/) != -1) {
                callback(true);
            } else {
                callback(false);
            }
        };
        // 定义最上边表头格式
        var columns1 = [
            { data: 0, readOnly: true, type: 'text', wordWrap: false },
            { data: 1, readOnly: false, type: 'text' },
            { data: 2, type: 'text', validator: phonenoValidator },
            { data: 3, renderer: 'html', readonly: false },
            { data: 4, renderer: 'html', readonly: false },
            { data: 5, type: 'text', validator: emailValidator },
            { data: 6, renderer: 'html', readonly: false },
            { data: 7, renderer: 'html', readonly: false }
        ];
        var colHeaders1 = ['ID', '姓名', '手机号', '接收短信', '允许时间段', 'EMAIL', '接收Email', "<a id='addBtn' href='javascript:addRow()'><span class='fa fa-edit'></span></a>"];
        // 单选框点击响应函数
        function upchk(a, r, c) {
            var vv = $(a).val();
            if ($(a).get(0).checked) {
                editHot.setDataAtCell(r, c, true);
            } else {
                editHot.setDataAtCell(r, c, false);
            }

        }
        //此段函数是写点击选择框调用允许时间前段时间选择器的
        function picktime(a, e, r) {

            $(a).bind('click', function(event) { timePacker($(this), event, r) });

        }

        /**
         * 自主封装一个时间插件
         * $dom.bind('click',function(event){timePacker($(this),event)});
         * @author shuaiwu Li
         */
        function timePacker(dom, e, r) {
            var hours = null; //存储 "时"
            var minutes = null; //存储 "分"
            var clientY = dom.offset().top + dom.height(); //获取位置
            var clientX = dom.offset().left;
            var date = new Date();
            var nowHours = date.getHours();
            var nowMinutes = date.getMinutes();
            var time_hm = /^(0\d{1}|\d{1}|1\d{1}|2[0-3]):([0-5]\d{1})$/; //时间正则，防止手动输入的时间不符合规范
            var inputText = dom.is("input") ? dom.val() : dom.text();
            //插件容器布局
            var html = '';
            html += '<div class="timePacker">';
            html += '<div class="timePacker-hours" style="display: block;">';
            html += '<div class="timePacker-title"><span>小时</span></div>';
            html += '<div class="timePacker-content">';
            html += '<ul>';
            var i = 0;
            while (i < 24) {
                //var text = i < 10 ? "0" + i : i;
                if (inputText !== "" && Number(inputText.split(":")[0]) === i) {
                    html += '<li class="hoursList timePackerSelect">' + i + '</li>';
                    hours = Number(inputText.split(":")[0]);
                } else {
                    if (i === nowHours) {
                        html += '<li class="hoursList" style="color: #007BDB;">' + i + '</li>';
                    } else {
                        html += '<li class="hoursList">' + i + '</li>';
                    }
                }
                i++;
            }
            html += '</ul>';
            html += '</div>';
            html += '</div>';
            html += '<div class="timePacker-minutes" style="display: none;">';
            html += '<div class="timePacker-title"><span>分钟</span><span class="timePacker-back-hours" title="返回小时选择"><img src="../img/back.png"/> </span></div>';
            html += '<div class="timePacker-content">';
            html += '<ul>';
            var m = 0;
            while (m < 60) {
                var textM = m < 10 ? "0" + m : m;
                if (inputText !== "" && Number(inputText.split(":")[1]) === textM) {
                    html += '<li class="mList timePackerSelect">' + textM + '</li>';
                    minutes = Number(inputText.split(":")[1]);
                } else {
                    if (m === nowMinutes) {
                        html += '<li class="mList" style="color: #007BDB;">' + textM + '</li>';
                    } else {
                        html += '<li class="mList">' + textM + '</li>';
                    }
                }
                m++;
            }
            html += '</ul>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            if ($(".timePacker").length > 0) {
                $(".timePacker").remove();
            }
            $("body").append(html);
            $(".timePacker").css({
                position: "absolute",
                top: clientY,
                left: clientX
            });
            var _con = $(".timePacker"); // 设置目标区域,如果当前鼠标点击非此插件区域则移除插件
            $(document).mouseup(function(e) {
                if (!_con.is(e.target) && _con.has(e.target).length === 0) { // Mark 1
                    _con.remove();
                }
            });
            //小时选择
            $(".hoursList").bind('click', function() {
                $(this).addClass("timePackerSelect").siblings().removeClass("timePackerSelect");
                hours = $(this).text();
                var timer = setTimeout(function() {
                    $(".timePacker-hours").css("display", "none");
                    $(".timePacker-minutes").fadeIn();
                    if (minutes !== null) {
                        var getTime = hours + ":" + minutes;
                        if (time_hm.test(getTime)) {
                            dom.removeClass("errorStyle");
                        }
                        dom.is("input") ? dom.val(getTime) : dom.text(getTime);
                    }
                    clearTimeout(timer);
                }, 100);

            });
            //返回小时选择
            $(".timePacker-back-hours").bind('click', function() {
                var timer = setTimeout(function() {
                    $(".timePacker-minutes").css("display", "none");
                    $(".timePacker-hours").fadeIn();
                    clearTimeout(timer);
                }, 500);
            });
            //分钟选择
            $(".mList").bind('click', function() {
                $(this).addClass("timePackerSelect").siblings().removeClass("timePackerSelect");
                minutes = $(this).text();
                var timer = setTimeout(function() {
                    var getTime = hours + ":" + minutes;
                    if (time_hm.test(getTime)) {
                        dom.removeClass("errorStyle");
                    }
                    dom.is("input") ? dom.val(getTime) : dom.text(getTime);
                    clearTimeout(timer);
                    _con.remove();
                    var oo = $("#open_" + r).val().split(':');
                    var cc = $("#close_" + r).val().split(':');
                    var aa = oo[0] * 60 + oo[1] * 1;
                    var bb = cc[0] * 60 + cc[1] * 1;
                    console.log(aa + ',' + bb);
                    editHot.setDataAtCell(r, 4, aa + ',' + bb);
                }, 500);

            })
        }

        // 最上边表格渲染器
        function negativeValueRenderer_user(instance, td, row, col, prop, value, cellProperties) {
            var id;
            id = editHot.getDataAtCell(row, 0);
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            switch (prop) {
                case 3:
                    var str = "<input type='checkbox' id='chkmsg" + row + "' onchange='upchk(this," + row + "," + col + ")'";
                    if (value) str = str + " checked ";
                    str = str + "/>";
                    td.innerHTML = str;

                    break;
                case 4:
                    if (value != null) {
                        var aa = 0,
                            bb = 0;
                        var vals = value.split(',');
                        aa = Math.floor(vals[0] / 60);
                        bb = vals[0] % 60;
                        cc = Math.floor(vals[1] / 60);
                        dd = vals[1] % 60;
                        aa = ("" + (100 + aa)).substring(1);
                        bb = ("" + (100 + bb)).substring(1);
                        cc = ("" + (100 + cc)).substring(1);
                        dd = ("" + (100 + dd)).substring(1);
                        Handsontable.renderers.HtmlRenderer.apply(this, arguments);
                        var str = "<input style='width:40px; color: #fff;background: 0 0;border: 0px ;' type=\"text\"  onclick='picktime(this,event," + row + ")' value='" + aa + ":" + bb + "'  id=\"open_" + row + "\"/> - <input style='width:40px; color: #fff;background: 0 0;border: 0px ;' type=\"text\"  onclick='picktime(this,event," + row + ")'  value='" + cc + ":" + dd + "'  id=\"close_" + row + "\" />";
                        td.innerHTML = str;

                    }
                    break;
                case 6:

                    var str = "<input type='checkbox' id='chkmail" + id + "' ";
                    if (value) str = str + " checked ";
                    str = str + "/>";

                    td.innerHTML = str;

                    break;
                case 7:
                    Handsontable.renderers.HtmlRenderer.apply(this, arguments);
                    break;
                default:
                    ;
            }


        }
        // 注册渲染器
        Handsontable.renderers.registerRenderer('userRenderer', negativeValueRenderer_user);
        // 定义表格样式
        editHot = new Handsontable(document.getElementById('editCell'), {
            columns: columns1,
            data: [],
            formulas: true,
            outsideClickDeselects: false,
            stretchH: 'all',
            colHeaders: colHeaders1,
            rowHeaders: false,
            fillHandle: false,
            colWidths: 60,
            contextMenu: false,
            disableVisualSelection: false,
            className: 'htCenter',
            enterBeginsEditing: false,
            multiSelect: true,
            beforeOnCellMouseDown: function(event, coords) {
                if (coords.row < 0) {
                    event.stopImmediatePropagation();
                }
            },
            cells: function(row, col, prop) {
                var cellProperties = {};
                cellProperties.renderer = "userRenderer";
                if (col == 3) cellProperties.readOnly = true; //不让编辑
                if (col == 4) cellProperties.readOnly = true;
                if (col == 6) cellProperties.readOnly = true;
                if (col == 7) cellProperties.readOnly = true;
                return cellProperties;
            }
        });
        // 新增加一行及内容
        function addRow() {
            if (editHot != null) {
                editHot.alter('insert_row', editHot.countRows());
                var lastRow = editHot.countRows() - 1;
                //editHot.setDataAtCell(lastRow, 1,lastRow+1)
                editHot.setDataAtCell(lastRow, 1, '');
                editHot.setDataAtCell(lastRow, 2, '');
                editHot.setDataAtCell(lastRow, 3, false);
                editHot.setDataAtCell(lastRow, 4, '0,1439');
                editHot.setDataAtCell(lastRow, 5, ' ');
                editHot.setDataAtCell(lastRow, 6, false);

                editHot.setDataAtCell(lastRow, 7, "<a id='subBtn' href='javascript:void(0);'><span class='fa fa-save'></span></a>&nbsp;&nbsp;&nbsp;&nbsp;<a id='delBtn' href='javascript:void(0);'><span class='glyphicon glyphicon-trash'></span></a>");
            }
        }
        // 初始化调用函数
        function init() {
            loadPlan();
            // loadauthor();
            getuserauthor(1);
        }


        // 查询用户表信息
        function loadPlan() {

            $.ajax({
                url: httpIp + '/LF/getuser',
                type: 'POST',
                async: true,
                timeout: timeOutNum,
                dataType: 'json',
                // beforeSend: beforeSend, //发送请求        
                // complete: complete, //请求完成    
                success: function(data, textStatus, jqXHR) {
                    console.log(data.data[0][1]);
                    if (data.result == 1) {
                        $("#zjTitle").html("<font size='" + titleFontSize + "'>" + "  短信用户列表" + "</font>");

                        // $("#authorTitle").html("<font size='" + titleFontSize + "'>" +data.data[0][1] + "  短信权限列表" + "</font>");
                        $("#authorTitle2").html(" " + data.data[0][1] + " " + "</font>");
                        $("#authorTitle3").html(" " + data.data[0][1] + " " + "</font>");
                        editData = [];

                        editData = JSON.parse(JSON.stringify(data.data));
                        editDataBk = JSON.stringify(editData); //editDataBk保存初始数据，用来判断表格内容是否有改动
                        editHot.loadData(editData)

                    } else {
                        editData = [];
                        editDataBk = JSON.stringify(editData);
                    }
                },
                error: function(xhr, textStatus) {
                    editHot.loadData([]);
                }
            })
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 

        }
        // 下面表格
        function loadauthor() {

            $.ajax({
                url: httpIp + '/LF/getauthor',
                type: 'POST',
                async: false,
                timeout: timeOutNum,
                dataType: 'json',
                // beforeSend: beforeSend, //发送请求        
                // complete: complete, //请求完成    
                success: function(data, textStatus, jqXHR) {
                    if (data.result == 1) {
                        console.log(data);
                        roomno = [];
                        deviceno = [];
                        devicenm = [];
                        roomno = JSON.parse(JSON.stringify(data.roomno));
                        deviceno = JSON.parse(JSON.stringify(data.deviceno));
                        devicenm = JSON.parse(JSON.stringify(data.devicenm));
                        for (var i = 0; i < 15; i++)
                            $("#rm" + i).html("");
                        for (var i = 0; i < roomno.length; i++) {

                            $("#rm" + roomno[i]).append(devicenm[i] + "&nbsp;<input id='ck" + deviceno[i] + "' name='chkItem' type=checkbox > </option>&nbsp;&nbsp;");

                        }

                    }
                },
                error: function(xhr, textStatus) {
                    editHot.loadData([]);
                }
            })
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 

        }

        function saveauthor() {
            var strs = "";
            for (var i = 0; i < 100; i++) {
                if ($("#ck" + i).prop("checked")) strs = strs + i + ",";
            }
            strs = strs + "99";
            $.ajax({
                url: httpIp + '/LF/set_author',
                type: 'POST',
                async: false,
                timeout: timeOutNum,
                data: { devs: strs, uid: nowMode },
                dataType: 'json',
                beforeSend: beforeSend, //发送请求        
                complete: complete, //请求完成    
                success: function(data, textStatus, jqXHR) {
                    if (data.result == 1) {
                        console.log(data);
                        alert('提交成功');

                    }
                },
                error: function(xhr, textStatus) {
                    editHot.loadData([]);
                }
            })
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 

        }

        function getuserauthor(sn, nm) {
            nowMode = sn;
            loadauthor();
            // $("#authorTitle").html("<font size='" + titleFontSize + "'>" +nm + "  短信权限列表" + "</font>");
            //$("#authorTitle2").html(" " + nm + "  " + "</font>");
            $.ajax({
                url: httpIp + '/LF/getUserAuthor',
                type: 'POST',
                async: false,
                timeout: timeOutNum,
                data: { uId: sn },
                dataType: 'json',
                // beforeSend: beforeSend, //发送请求        
                // complete: complete, //请求完成    
                success: function(data, textStatus, jqXHR) {
                    if (data.result == 1) {
                        console.log(data);

                        deviceno = [];


                        deviceno = JSON.parse(JSON.stringify(data.deviceno));

                        // $("[name = chkItem]:checkbox").attr("checked", false);
                        for (var i = 0; i < deviceno.length; i++) {
                            // $("#rm"+roomno[i]).append(devicenm[i]+"&nbsp;<input id="+deviceno[i]+" type=checkbox > </option>&nbsp;&nbsp;");
                            $("#ck" + deviceno[i]).prop("checked", true);
                        }


                    }
                },
                error: function(xhr, textStatus) {
                    editHot.loadData([]);
                }
            })
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 
            //$("#rm2").append(" ddd &nbsp;<input  type=checkbox > </option>&nbsp;&nbsp;"); 

        }

        function findSN(sn, newJson) {
            for (var i = 0; i < newJson.length; i++) {
                if (newJson[i][0] == sn) {
                    return true;
                }
            }
            return false;
        }
        //取得修改过内容的newjson行
        function findNewEdit(sn, newJson) {
            for (var i = 0; i < newJson.length; i++) {
                if (newJson[i][0] == sn) {
                    return newJson[i]
                }
            }
            return null
        }

        //用oldjson中的每一行跟newjson中的所有行比较，找到有修改过的
        function findEdit(node, newJson) {
            for (var i = 0; i < newJson.length; i++) {
                // console.log("node:"+node);
                // console.log("newjson:"+newJson[i].toString());

                if (node.indexOf(newJson[i].toString()) >= 0) {
                    //  console.log("false");
                    return false;
                }
            }
            //console.log("true");
            return true;

        }

        function allcheck() {
            for (var i = 0; i < 100; i++) {

                $("#ck" + i).prop("checked", true);
            }
        }

        function allnotcheck() {
            for (var i = 0; i < 100; i++) {

                $("#ck" + i).prop("checked", false);
            }
        }

        function notcheck() {
            for (var i = 0; i < 100; i++) {
                if ($("#ck" + i).prop("checked")) {
                    $("#ck" + i).prop("checked", false);
                } else {
                    $("#ck" + i).prop("checked", true);
                }
                //$("#ck"+i).attr("checked", false);
            }
        }
        $(document).on("click", "#subBtn", function() { submitCell(); });
        $(document).on("click", "#delBtn", function() {
            if (editHot.getSelected() != null) {
                if (window.confirm("确认删除该用户?") == true) {
                    editHot.alter('remove_row', editHot.getSelected()[0]);
                    submitCell();
                }
            }
        });
        $(document).on("click", "#savBtn", function() { saveauthor(); });
        $(document).on("click", "#allBtn", function() { allcheck(); });
        $(document).on("click", "#allnotBtn", function() { allnotcheck(); });
        $(document).on("click", "#notBtn", function() { notcheck(); });

        //处理最上面表格的增删改
        function submitCell() {

            editHot.validateCells(function(result, obj) {
                if (result == true) {
                    var addArr = [] //此数组用来保存新增加的内容
                    var editArr = [] //用来保存内容有修改的表格行
                    var delArr = [] //删除的行
                    var oldJson

                    if (editDataBk == "") {
                        oldJson = []
                    } else {
                        oldJson = JSON.parse(editDataBk)
                    }
                    var newJson = editHot.getData()
                    //console.log(oldJson + "  oldjson ")
                    for (var i = 0; i < oldJson.length; i++) {
                        var sn = oldJson[i][0]

                        var have = findSN(sn, newJson)
                        if (have) {
                            //用oldjson中的每一行跟newjson中的所有行比较，找到有修改过的
                            var edited = findEdit(oldJson[i].toString(), newJson)
                            if (edited) {
                                var editNode = findNewEdit(sn, newJson)
                                if (editNode != null) {
                                    editArr.push(editNode)
                                }
                            }
                        } else {
                            delArr.push(sn);
                        }
                    }

                    for (var j = 0; j < newJson.length; j++) {
                        if (newJson[j][0] == null || newJson[j][0] == "") {
                            addArr.push(newJson[j])
                        }
                    }
                    if (addArr.length == 0 && editArr.length == 0 && delArr.length == 0) {
                        alert('没有更新内容')
                        return;
                    }

                    var postObj = {}
                    postObj.addArr = addArr
                    postObj.editArr = editArr
                    postObj.delArr = delArr
                    var postJson = JSON.stringify(postObj)
                    //postJson = postJson.replace(/降至/g, 0).replace(/升至/g, 1);
                    //postJson = jzReplace(postJson)
                    console.log(postJson + "  json ")

                    $.ajax({
                        url: httpIp + '/LF/saveyTfEdit',
                        type: 'POST',
                        async: true,
                        data: { jsonStr: postJson, sn: 1 },
                        timeout: timeOutNum,
                        dataType: 'text',
                        beforeSend: function(xhr) {

                        },
                        success: function(data, textStatus, jqXHR) {
                            data = JSON.parse(data)
                            if (data.result == 1) {

                                //console.log(data)
                                loadPlan()

                                alert('提交成功')

                            } else {
                                alert('提交失败')
                            }


                        },
                        error: function(xhr, textStatus) {
                            alert('提交失败')
                            console.log(xhr)
                            console.log(textStatus)
                        },
                        complete: function() {}
                    })

                } else {
                    alert('数据填写错误')
                }
            });

        }

        init();
        </script>
</body>

</html>